#!/bin/bash

# See https://XonqNopp.github.io/_build/html/git-sub.html

git status -sb
main=$(git status -s)

curDir=$PWD
topDir=$(git rev-parse --show-toplevel)
if [ "$topDir" = "" ]; then
	echo "Not a git repository"
	exit 1
fi

cd $topDir

gitsub=".gitsub"
if [ ! -f "$gitsub" ]; then
	exit 0
fi

for sub in $(cat $gitsub | cut -f1); do
	cd $sub

	if [ ! -d ".git" ]; then
		echo "$sub: Not a git repository, are you sure you did 'git sub-init' yet?"
		exit 1
	fi

	subStatus=$(git status -s | wc -l)
	subRemote=$(git status -sb | head -n 1)
	subBranch=$(git branch --color=never 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/\1/')

	cd - > /dev/null

	echo -n "$sub: "
	if [ "$subStatus" = "0" ]; then
		echo "clean @$subBranch"

		if [[ "$subRemote" != *"..."* ]]; then
			echo "WARNING: the sub's branch is not remotely tracked yet."
			echo "Please push it to the remote ASAP."
			exit 1
		fi

		if [[ "$subRemote" == *"["* ]]; then
			echo "WARNING: sub has local commits not pushed to its remote yet."
			echo "Please push them to the remote ASAP."
			exit 1
		fi

	else
		echo "dirty @$subBranch"

		if [[ "$main" != *"$sub/"* ]]; then
			echo "WARNING: we have changes committed to main repo BUT NOT to sub's remote."
			echo "Please commit and push in sub ASAP."
			exit 1
		fi
	fi
done

cd $curDir

