#!/bin/bash

# See https://XonqNopp.github.io/_build/html/git-sub.html

sub=$1
if [ "$#" = "0" ]; then
	echo "Usage: git sub-st path/to/sub1 [path/to/sub2...]"
	exit 1
fi

git status -sb
main=$(git status -s)

for sub in "$@"; do
	cd $sub

	if [ ! -d ".git" ]; then
		echo "$sub: Not a git repository, are you sure you did 'git sub-init' yet?"
		exit 1
	fi

	subStatus=$(git status -s | wc -l)
	subRemote=$(git status -sb | head -n 1)

	cd - > /dev/null

	echo -n "$sub: "
	if [ "$subStatus" = "0" ]; then
		echo "clean"

		if [[ "$subRemote" != *"..."* ]]; then
			echo "WARNING: the sub's branch is not remotely tracked yet."
			echo "Please push it to the remote ASAP."
			exit 1
		fi

		if [[ "$subRemote" == *"["* ]]; then
			echo "WARNING: sub has local commits not pushed to its remote yet."
			echo "Please push them to the remote ASAP."
			exit 1
		fi

	else
		echo "dirty"

		if [[ "$main" != *"$sub/"* ]]; then
			echo "WARNING: we have changes committed to main repo BUT NOT to sub's remote."
			echo "Please commit and push in sub ASAP."
			exit 1
		fi
	fi
done

